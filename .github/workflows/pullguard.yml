name: PullGuard Security Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  security-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: PullGuard Analysis
        run: |
          echo "ðŸ”’ Running PullGuard Security Analysis..."

          # Call PullGuard Azure API with supported parameters
          response=$(curl -X POST "https://pullguard-api-bzbqdzfdgqe8hne5.eastus-01.azurewebsites.net/api/v1/analyze-pr" \
            -H "X-API-Key: ${{ secrets.PULLGUARD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "github_token": "${{ secrets.GITHUB_TOKEN }}",
              "repository": "${{ github.repository }}",
              "pr_number": ${{ github.event.pull_request.number }},
              "mode": "ast",
              "comment_style": "summary"
            }' \
            -w "\n%{http_code}" \
            -o response.json)

          # Extract HTTP status code
          http_code=$(tail -n1 <<< "$response")

          echo "HTTP Status: $http_code"
          echo ""

          # Display response
          echo "ðŸ“Š Analysis Results:"
          cat response.json | jq '.'

          # Check if request was successful
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ Error: PullGuard API returned status $http_code"
            echo "Response:"
            cat response.json
            echo ""
            echo "âš ï¸  Check that PULLGUARD_API_KEY secret is set correctly"
            exit 1
          fi

          # Verify response has required fields
          if ! cat response.json | jq -e '.status' > /dev/null 2>&1; then
            echo "âŒ Error: Invalid API response format"
            cat response.json
            exit 1
          fi

          # Extract policy status
          policy_status=$(cat response.json | jq -r '.policy_status')

          echo ""
          echo "ðŸŽ¯ Policy Status: $policy_status"

          # Fail the job if critical violations found
          if [ "$policy_status" = "failed" ]; then
            echo "âš ï¸  Critical security violations detected!"
            exit 1
          fi

          echo "âœ… PullGuard analysis complete!"

      - name: Extract Artifacts from API Response
        if: always()
        run: |
          echo "ðŸ“¦ Extracting artifacts generated by PullGuard backend..."

          if [ ! -f "response.json" ]; then
            echo "âŒ response.json not found - API call may have failed"
            exit 0
          fi

          # Decode base64-encoded artifacts directly from API response
          jq -r '.pr_summary_b64 // ""' response.json | base64 -d > pr_summary.md
          jq -r '.issues_json_b64 // ""' response.json | base64 -d > issues.json
          jq -r '.policy_report_b64 // ""' response.json | base64 -d > policy_report.md
          jq -r '.report_html_b64 // ""' response.json | base64 -d > pullguard-report.html

          echo "âœ… Artifacts extracted from API response"
          ls -lh pr_summary.md issues.json policy_report.md pullguard-report.html 2>/dev/null || echo "âš ï¸  Some files missing"

      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pullguard-analysis
          path: |
            pr_summary.md
            issues.json
            policy_report.md
            pullguard-report.html

      - name: Job Summary
        if: always()
        run: |
          echo "## ðŸ”’ PullGuard Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "response.json" ] && jq -e '.status' response.json > /dev/null 2>&1; then

            # --- PR Summary (full content from backend) ---
            if [ -s "pr_summary.md" ]; then
              cat pr_summary.md >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # --- All Violations Table (from issues.json) ---
            if [ -s "issues.json" ] && jq -e '.violations.details | length > 0' issues.json > /dev/null 2>&1; then
              echo "### ðŸ“‹ Violations Detail" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| File | Line | Severity | Rule | Issue |" >> $GITHUB_STEP_SUMMARY
              echo "|------|------|----------|------|-------|" >> $GITHUB_STEP_SUMMARY
              jq -r '.violations.details[] | "| `\(.file)` | \(.line) | \(.severity | ascii_upcase) | `\(.rule_id // "N/A")` | \(.message) |"' issues.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # --- Policy Report (collapsible) ---
            if [ -s "policy_report.md" ]; then
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>ðŸ“Š Full Policy Compliance Report (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              cat policy_report.md >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # --- Download link ---
            echo "**[ðŸ“¥ Download Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)** â€” includes pr_summary.md, issues.json, policy_report.md, pullguard-report.html" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "*Powered by [PullGuard](https://github.com/sristikulkarni-gif/PullGuardProject) - Azure AI Security Analysis*" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ API call failed â€” no analysis data available. Check that PULLGUARD_API_KEY secret is set." >> $GITHUB_STEP_SUMMARY
          fi
