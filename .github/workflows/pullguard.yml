name: PullGuard Security Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  security-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: PullGuard Analysis
        run: |
          echo "ðŸ”’ Running PullGuard Security Analysis..."

          # Call PullGuard Azure API with supported parameters
          response=$(curl -X POST "https://pullguard-api-bzbqdzfdgqe8hne5.eastus-01.azurewebsites.net/api/v1/analyze-pr" \
            -H "X-API-Key: ${{ secrets.PULLGUARD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "github_token": "${{ secrets.GITHUB_TOKEN }}",
              "repository": "${{ github.repository }}",
              "pr_number": ${{ github.event.pull_request.number }},
              "mode": "ai",
              "comment_style": "inline"
            }' \
            -w "\n%{http_code}" \
            -o response.json)

          # Extract HTTP status code
          http_code=$(tail -n1 <<< "$response")

          echo "HTTP Status: $http_code"
          echo ""

          # Display response
          echo "ðŸ“Š Analysis Results:"
          cat response.json | jq '.'

          # Check if request was successful
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ Error: PullGuard API returned status $http_code"
            echo "Response:"
            cat response.json
            echo ""
            echo "âš ï¸  Check that PULLGUARD_API_KEY secret is set correctly"
            exit 1
          fi

          # Verify response has required fields
          if ! cat response.json | jq -e '.status' > /dev/null 2>&1; then
            echo "âŒ Error: Invalid API response format"
            cat response.json
            exit 1
          fi

          # Extract policy status
          policy_status=$(cat response.json | jq -r '.policy_status')

          echo ""
          echo "ðŸŽ¯ Policy Status: $policy_status"

          # Fail the job if critical violations found
          if [ "$policy_status" = "failed" ]; then
            echo "âš ï¸  Critical security violations detected!"
            exit 1
          fi

          echo "âœ… PullGuard analysis complete!"

      - name: Extract Artifacts from API Response
        if: always()
        run: |
          echo "ðŸ“¦ Extracting artifacts generated by PullGuard backend..."

          if [ ! -f "response.json" ]; then
            echo "âŒ response.json not found - API call may have failed"
            exit 0
          fi

          # Decode base64-encoded artifacts directly from API response
          jq -r '.pr_summary_b64 // ""' response.json | base64 -d > pr_summary.md
          jq -r '.issues_json_b64 // ""' response.json | base64 -d > issues.json
          jq -r '.policy_report_b64 // ""' response.json | base64 -d > policy_report.md
          jq -r '.report_html_b64 // ""' response.json | base64 -d > pullguard-report.html

          echo "âœ… Artifacts extracted from API response"
          ls -lh pr_summary.md issues.json policy_report.md pullguard-report.html 2>/dev/null || echo "âš ï¸  Some files missing"

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          destination_dir: reports/pr-${{ github.event.pull_request.number }}
          keep_files: true
          enable_jekyll: false

      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pullguard-analysis
          path: |
            pr_summary.md
            issues.json
            policy_report.md
            pullguard-report.html

      - name: Job Summary
        if: always()
        run: |
          echo "## ðŸ”’ PullGuard Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "response.json" ] && jq -e '.status' response.json > /dev/null 2>&1; then
            violations_total=$(jq -r '.violations.total // "0"' response.json 2>/dev/null || echo "0")
            violations_critical=$(jq -r '.violations.critical // "0"' response.json 2>/dev/null || echo "0")
            violations_high=$(jq -r '.violations.high // "0"' response.json 2>/dev/null || echo "0")
            violations_medium=$(jq -r '.violations.medium // "0"' response.json 2>/dev/null || echo "0")
            violations_low=$(jq -r '.violations.low // "0"' response.json 2>/dev/null || echo "0")
            ai_suggestions=$(jq -r '.ai_suggestions // "0"' response.json 2>/dev/null || echo "0")
            ast_comments=$(jq -r '.ast_comments_posted // "0"' response.json 2>/dev/null || echo "0")
            comments_posted=$(jq -r '.comments_posted // "0"' response.json 2>/dev/null || echo "0")
            policy_status=$(jq -r '.policy_status // "unknown"' response.json 2>/dev/null || echo "unknown")

            echo "**Policy Status:** \`$policy_status\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### ðŸ“Š Analysis Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**AST Policy Violations:** $violations_total _(all posted, no limit)_" >> $GITHUB_STEP_SUMMARY
            echo "**AST Inline Comments:** $ast_comments" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ Critical: $violations_critical" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  High: $violations_high" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Medium: $violations_medium" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”µ Low: $violations_low" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ¤– AI-Powered Code Fixes:** $ai_suggestions _(max: 30)_" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Comments Posted:** $comments_posted" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### ðŸŒ Interactive Report Viewer" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**[ðŸš€ Open Interactive Report](https://sristikulkarni-gif.github.io/${{ github.event.repository.name }}/reports/pr-${{ github.event.pull_request.number }}/pullguard-report.html)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘† Click above to view the report directly in your browser (no download needed!)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The interactive viewer includes:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ›¡ï¸ **Beautiful PullGuard UI** with statistics dashboard" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“„ **PR Summary** - View in modal dialog" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“‹ **Issues JSON** - Formatted with syntax highlighting" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“Š **Policy Report** - Full compliance details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Download Raw Files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**[ðŸ“¥ Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)** (scroll to bottom of page)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Files included in \`pullguard-analysis.zip\`:" >> $GITHUB_STEP_SUMMARY
            echo "- \`pr_summary.md\` - Markdown summary" >> $GITHUB_STEP_SUMMARY
            echo "- \`issues.json\` - Machine-readable findings" >> $GITHUB_STEP_SUMMARY
            echo "- \`policy_report.md\` - Policy compliance report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### ðŸ“ Quick View" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View PR Summary (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f "pr_summary.md" ]; then
              cat pr_summary.md >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "_ðŸ’¡ Click on AI suggestions in PR comments to apply fixes directly_" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "*Powered by [PullGuard](https://github.com/sristikulkarni-gif/PullGuardProject) - Azure AI Security Analysis*" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No response data available" >> $GITHUB_STEP_SUMMARY
          fi
