name: PullGuard Security Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

jobs:
  security-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: PullGuard Analysis
        run: |
          echo "üîí Running PullGuard Security Analysis..."

          # Call PullGuard Azure API with supported parameters
          response=$(curl -X POST "https://pullguard-api-bzbqdzfdgqe8hne5.eastus-01.azurewebsites.net/api/v1/analyze-pr" \
            -H "X-API-Key: ${{ secrets.PULLGUARD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "github_token": "${{ secrets.GITHUB_TOKEN }}",
              "repository": "${{ github.repository }}",
              "pr_number": ${{ github.event.pull_request.number }},
              "mode": "all",
              "comment_style": "both"
            }' \
            -w "\n%{http_code}" \
            -o response.json)

          # Extract HTTP status code
          http_code=$(tail -n1 <<< "$response")

          echo "HTTP Status: $http_code"
          echo ""

          # Display response
          echo "üìä Analysis Results:"
          cat response.json | jq '.'

          # Check if request was successful
          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå Error: PullGuard API returned status $http_code"
            cat response.json
            exit 1
          fi

          # Extract policy status
          policy_status=$(cat response.json | jq -r '.policy_status')

          echo ""
          echo "üéØ Policy Status: $policy_status"

          # Fail the job if critical violations found
          if [ "$policy_status" = "failed" ]; then
            echo "‚ö†Ô∏è  Critical security violations detected!"
            exit 1
          fi

          echo "‚úÖ PullGuard analysis complete!"

      - name: Generate Artifact Files
        if: always()
        run: |
          echo "üìÅ Generating artifact files..."

          # Create artifacts directory
          mkdir -p pullguard-artifacts

          # Extract data from API response
          pr_summary=$(cat response.json | jq -r '.pr_summary')
          violations=$(cat response.json | jq '.violations')
          policy_status=$(cat response.json | jq -r '.policy_status')

          # Generate pr_summary.md
          echo "$pr_summary" > pullguard-artifacts/pr_summary.md
          echo "‚úÖ Generated pr_summary.md"

          # Generate issues.json (already have this from response)
          cat response.json | jq '{
            repository: "${{ github.repository }}",
            pr_number: ${{ github.event.pull_request.number }},
            timestamp: .timestamp,
            violations_count: .violations.total,
            policy_status: .policy_status,
            violations: .violations.details,
            ai_suggestions: .ai_suggestions,
            cost_summary: .cost_summary
          }' > pullguard-artifacts/issues.json
          echo "‚úÖ Generated issues.json"

          # Generate policy_report.md
          cat > pullguard-artifacts/policy_report.md << 'EOFPOLICY'
          # PullGuard Policy Compliance Report

          **Generated:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          **Overall Status:** $(if [ "$policy_status" = "failed" ]; then echo "‚ùå FAILED"; else echo "‚úÖ PASSED"; fi)

          ## Summary

          - **Total Violations:** $(cat response.json | jq -r '.violations.total')
          - **Critical:** $(cat response.json | jq -r '.violations.critical')
          - **High:** $(cat response.json | jq -r '.violations.high')
          - **Medium:** $(cat response.json | jq -r '.violations.medium')
          - **Low:** $(cat response.json | jq -r '.violations.low')

          ## Policy Rules

          PullGuard enforces the following security policies:

          1. **No Hardcoded Secrets** - API keys, passwords, tokens must use environment variables
          2. **No SQL Injection** - Use parameterized queries, never concatenate user input
          3. **No Command Injection** - Avoid shell=True, sanitize inputs
          4. **No eval/exec** - Dangerous code execution functions prohibited
          5. **Strong Cryptography** - No MD5/SHA1, use SHA256+ or bcrypt/argon2
          6. **Secure Random** - Use secrets module for cryptographic operations
          7. **No Insecure Deserialization** - Avoid pickle with untrusted data

          ## Recommendations

          $(if [ "$policy_status" = "failed" ]; then
            echo "- ‚ùå **This PR should not be merged** until critical and high severity issues are resolved"
            echo "- Review the inline comments on the PR for specific fixes"
            echo "- Apply AI-suggested fixes where available (click to apply)"
          else
            echo "- ‚úÖ **This PR passes all security policies** and can be merged"
            echo "- Review any low/medium severity warnings for code quality improvements"
          fi)

          ---
          _Generated by PullGuard - Azure AI Security Analysis_
          EOFPOLICY

          # Execute the heredoc to expand variables
          eval "cat > pullguard-artifacts/policy_report.md" << EOF
          # PullGuard Policy Compliance Report

          **Generated:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          **Overall Status:** $(if [ "$policy_status" = "failed" ]; then echo "‚ùå FAILED"; else echo "‚úÖ PASSED"; fi)

          ## Summary

          - **Total Violations:** $(cat response.json | jq -r '.violations.total')
          - **Critical:** $(cat response.json | jq -r '.violations.critical')
          - **High:** $(cat response.json | jq -r '.violations.high')
          - **Medium:** $(cat response.json | jq -r '.violations.medium')
          - **Low:** $(cat response.json | jq -r '.violations.low')

          ## Policy Rules

          PullGuard enforces the following security policies:

          1. **No Hardcoded Secrets** - API keys, passwords, tokens must use environment variables
          2. **No SQL Injection** - Use parameterized queries, never concatenate user input
          3. **No Command Injection** - Avoid shell=True, sanitize inputs
          4. **No eval/exec** - Dangerous code execution functions prohibited
          5. **Strong Cryptography** - No MD5/SHA1, use SHA256+ or bcrypt/argon2
          6. **Secure Random** - Use secrets module for cryptographic operations
          7. **No Insecure Deserialization** - Avoid pickle with untrusted data

          ## Recommendations

          $(if [ "$policy_status" = "failed" ]; then
            echo "- ‚ùå **This PR should not be merged** until critical and high severity issues are resolved"
            echo "- Review the inline comments on the PR for specific fixes"
            echo "- Apply AI-suggested fixes where available (click to apply)"
          else
            echo "- ‚úÖ **This PR passes all security policies** and can be merged"
            echo "- Review any low/medium severity warnings for code quality improvements"
          fi)

          ---
          _Generated by PullGuard - Azure AI Security Analysis_
          EOF

          echo "‚úÖ Generated policy_report.md"
          echo ""
          echo "üì¶ All artifacts generated in pullguard-artifacts/"

      - name: Generate Interactive HTML Viewer
        if: always()
        run: |
          echo "üåê Generating interactive HTML viewer..."

          # Create HTML template with embedded content
          cat > pullguard-artifacts/pullguard-report.html << 'HTMLEOF'
<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>PullGuard Security Report</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1200px;margin:0 auto}.header{text-align:center;color:#fff;margin-bottom:40px}.header h1{font-size:3em;font-weight:700;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}.header .shield-icon{font-size:4em;margin-bottom:20px}.header p{font-size:1.2em;opacity:.95}.card{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:40px;margin-bottom:30px}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:40px}.stat-box{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:12px;text-align:center}.stat-box h3{font-size:2.5em;margin-bottom:5px}.stat-box p{opacity:.9;font-size:.9em}.buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-top:30px}.btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px 30px;border:none;border-radius:12px;font-size:1.1em;font-weight:600;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 15px rgba(102,126,234,.4)}.btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.6)}.btn-icon{margin-right:10px;font-size:1.2em}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);backdrop-filter:blur(5px);animation:fadeIn .3s ease}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.modal-content{background-color:#fefefe;margin:5% auto;padding:0;border-radius:16px;width:90%;max-width:900px;max-height:85vh;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:slideUp .3s ease}@keyframes slideUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}.modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px 30px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-size:1.5em}.close{color:#fff;font-size:28px;font-weight:700;cursor:pointer;background:rgba(255,255,255,.2);width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .3s ease}.close:hover{background:rgba(255,255,255,.3);transform:rotate(90deg)}.modal-body{padding:30px;max-height:calc(85vh - 100px);overflow-y:auto}.content-display{background:#f8f9fa;border:1px solid #e9ecef;border-radius:8px;padding:20px;font-family:Monaco,Menlo,'Ubuntu Mono',monospace;font-size:14px;line-height:1.6;white-space:pre-wrap;word-wrap:break-word}.json-content{background:#282c34;color:#abb2bf}.markdown-content{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;line-height:1.8;white-space:normal}.markdown-content h1{color:#667eea;margin-top:0;margin-bottom:20px}.markdown-content h2{color:#764ba2;margin-top:30px;margin-bottom:15px}.markdown-content ul{margin-left:20px;margin-bottom:15px}.footer{text-align:center;color:#fff;margin-top:40px;opacity:.9}</style></head><body><div class="container"><div class="header"><div class="shield-icon">üõ°Ô∏è</div><h1>PullGuard</h1><p>AI-Powered Security Analysis Report</p></div><div class="card"><div class="stats" id="stats"></div><div class="buttons"><button class="btn" onclick="openModal('summary')"><span class="btn-icon">üìÑ</span> PR Summary</button><button class="btn" onclick="openModal('issues')"><span class="btn-icon">üìã</span> Issues (JSON)</button><button class="btn" onclick="openModal('policy')"><span class="btn-icon">üìä</span> Policy Report</button></div></div><div class="footer"><p>Powered by <strong>PullGuard</strong> - Azure AI Security Analysis</p><p style="font-size:.9em;margin-top:10px">ü§ñ Protecting your code, one PR at a time</p></div></div><div id="summaryModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>üìÑ PR Summary</h2><span class="close" onclick="closeModal('summary')">&times;</span></div><div class="modal-body"><div id="summaryContent" class="content-display markdown-content"></div></div></div></div><div id="issuesModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>üìã Issues (JSON)</h2><span class="close" onclick="closeModal('issues')">&times;</span></div><div class="modal-body"><pre id="issuesContent" class="content-display json-content"></pre></div></div></div><div id="policyModal" class="modal"><div class="modal-content"><div class="modal-header"><h2>üìä Policy Report</h2><span class="close" onclick="closeModal('policy')">&times;</span></div><div class="modal-body"><div id="policyContent" class="content-display markdown-content"></div></div></div></div><script>const prSummary=`__PR_SUMMARY__`;const issuesJson=`__ISSUES_JSON__`;const policyReport=`__POLICY_REPORT__`;try{const issues=JSON.parse(issuesJson);const stats=document.getElementById('stats');stats.innerHTML=`<div class="stat-box"><h3>${issues.violations_count||0}</h3><p>Total Violations</p></div><div class="stat-box"><h3>${issues.ai_suggestions||0}</h3><p>AI Suggestions</p></div><div class="stat-box"><h3>${issues.policy_status||'N/A'}</h3><p>Policy Status</p></div>`}catch(e){console.error('Error parsing stats:',e)}function markdownToHtml(markdown){return markdown.replace(/^### (.*$)/gim,'<h3>$1</h3>').replace(/^## (.*$)/gim,'<h2>$1</h2>').replace(/^# (.*$)/gim,'<h1>$1</h1>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/`(.*?)`/g,'<code>$1</code>').replace(/^- (.*$)/gim,'<ul><li>$1</li></ul>').replace(/<\/ul>\n<ul>/g,'').replace(/\n/g,'<br>')}function openModal(type){if(type==='summary'){document.getElementById('summaryContent').innerHTML=markdownToHtml(prSummary);document.getElementById('summaryModal').style.display='block'}else if(type==='issues'){try{const formatted=JSON.stringify(JSON.parse(issuesJson),null,2);document.getElementById('issuesContent').textContent=formatted}catch(e){document.getElementById('issuesContent').textContent=issuesJson}document.getElementById('issuesModal').style.display='block'}else if(type==='policy'){document.getElementById('policyContent').innerHTML=markdownToHtml(policyReport);document.getElementById('policyModal').style.display='block'}}function closeModal(type){if(type==='summary'){document.getElementById('summaryModal').style.display='none'}else if(type==='issues'){document.getElementById('issuesModal').style.display='none'}else if(type==='policy'){document.getElementById('policyModal').style.display='none'}}window.onclick=function(event){if(event.target.classList.contains('modal')){event.target.style.display='none'}};document.addEventListener('keydown',function(event){if(event.key==='Escape'){document.querySelectorAll('.modal').forEach(modal=>{modal.style.display='none'})}});</script></body></html>
          HTMLEOF

          # Embed the actual content into the HTML
          # Escape backticks and backslashes for JavaScript strings
          pr_summary_escaped=$(cat pullguard-artifacts/pr_summary.md | sed 's/`/\\`/g' | sed 's/\\/\\\\/g')
          issues_json_escaped=$(cat pullguard-artifacts/issues.json | sed 's/`/\\`/g' | sed 's/\\/\\\\/g')
          policy_report_escaped=$(cat pullguard-artifacts/policy_report.md | sed 's/`/\\`/g' | sed 's/\\/\\\\/g')

          # Replace placeholders with actual content
          sed -i "s|__PR_SUMMARY__|${pr_summary_escaped}|g" pullguard-artifacts/pullguard-report.html
          sed -i "s|__ISSUES_JSON__|${issues_json_escaped}|g" pullguard-artifacts/pullguard-report.html
          sed -i "s|__POLICY_REPORT__|${policy_report_escaped}|g" pullguard-artifacts/pullguard-report.html

          echo "‚úÖ Generated pullguard-report.html"
          echo "üåê HTML viewer is ready with all content embedded!"

      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pullguard-analysis
          path: |
            response.json
            pullguard-artifacts/

      - name: Job Summary
        if: always()
        run: |
          echo "## üîí PullGuard Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "response.json" ]; then
            violations_total=$(cat response.json | jq -r '.violations.total')
            violations_critical=$(cat response.json | jq -r '.violations.critical')
            violations_high=$(cat response.json | jq -r '.violations.high')
            violations_medium=$(cat response.json | jq -r '.violations.medium')
            violations_low=$(cat response.json | jq -r '.violations.low')
            ai_suggestions=$(cat response.json | jq -r '.ai_suggestions')
            comments_posted=$(cat response.json | jq -r '.comments_posted')
            policy_status=$(cat response.json | jq -r '.policy_status')

            echo "**Policy Status:** \`$policy_status\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### üìä Analysis Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**AST Policy Violations:** $violations_total _(all posted, no limit)_" >> $GITHUB_STEP_SUMMARY
            echo "- üî¥ Critical: $violations_critical" >> $GITHUB_STEP_SUMMARY
            echo "- üü† High: $violations_high" >> $GITHUB_STEP_SUMMARY
            echo "- üü° Medium: $violations_medium" >> $GITHUB_STEP_SUMMARY
            echo "- üîµ Low: $violations_low" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ü§ñ AI-Powered Code Fixes:** $ai_suggestions _(max: 30)_" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Comments Posted:** $comments_posted" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### üåê Interactive Report Viewer" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**[üöÄ Open Interactive Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üëÜ Click above ‚Üí Download \`pullguard-analysis\` ‚Üí Open \`pullguard-report.html\` in your browser" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The interactive viewer includes:" >> $GITHUB_STEP_SUMMARY
            echo "- üõ°Ô∏è **Beautiful PullGuard UI** with statistics dashboard" >> $GITHUB_STEP_SUMMARY
            echo "- üìÑ **PR Summary** - View in modal dialog" >> $GITHUB_STEP_SUMMARY
            echo "- üìã **Issues JSON** - Formatted with syntax highlighting" >> $GITHUB_STEP_SUMMARY
            echo "- üìä **Policy Report** - Full compliance details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìÅ Raw Files (Also Available)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All files can be downloaded separately from the artifacts:" >> $GITHUB_STEP_SUMMARY
            echo "- \`pr_summary.md\` - Markdown summary" >> $GITHUB_STEP_SUMMARY
            echo "- \`issues.json\` - Machine-readable findings" >> $GITHUB_STEP_SUMMARY
            echo "- \`policy_report.md\` - Policy compliance report" >> $GITHUB_STEP_SUMMARY
            echo "- \`pullguard-report.html\` - ‚≠ê Interactive web viewer" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### üìù Quick View" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View PR Summary (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f "pullguard-artifacts/pr_summary.md" ]; then
              cat pullguard-artifacts/pr_summary.md >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "_üí° Click on AI suggestions in PR comments to apply fixes directly_" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "*Powered by [PullGuard](https://github.com/sristikulkarni-gif/PullGuardProject) - Azure AI Security Analysis*" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No response data available" >> $GITHUB_STEP_SUMMARY
          fi
