name: PullGuard Security Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

jobs:
  security-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: PullGuard Analysis
        run: |
          echo "ðŸ”’ Running PullGuard Security Analysis..."

          # Call PullGuard Azure API with supported parameters
          response=$(curl -X POST "https://pullguard-api-bzbqdzfdgqe8hne5.eastus-01.azurewebsites.net/api/v1/analyze-pr" \
            -H "X-API-Key: ${{ secrets.PULLGUARD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "github_token": "${{ secrets.GITHUB_TOKEN }}",
              "repository": "${{ github.repository }}",
              "pr_number": ${{ github.event.pull_request.number }},
              "mode": "all",
              "comment_style": "both"
            }' \
            -w "\n%{http_code}" \
            -o response.json)

          # Extract HTTP status code
          http_code=$(tail -n1 <<< "$response")

          echo "HTTP Status: $http_code"
          echo ""

          # Display response
          echo "ðŸ“Š Analysis Results:"
          cat response.json | jq '.'

          # Check if request was successful
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ Error: PullGuard API returned status $http_code"
            echo "Response:"
            cat response.json
            echo ""
            echo "âš ï¸  Check that PULLGUARD_API_KEY secret is set correctly"
            exit 1
          fi

          # Verify response has required fields
          if ! cat response.json | jq -e '.status' > /dev/null 2>&1; then
            echo "âŒ Error: Invalid API response format"
            cat response.json
            exit 1
          fi

          # Extract policy status
          policy_status=$(cat response.json | jq -r '.policy_status')

          echo ""
          echo "ðŸŽ¯ Policy Status: $policy_status"

          # Fail the job if critical violations found
          if [ "$policy_status" = "failed" ]; then
            echo "âš ï¸  Critical security violations detected!"
            exit 1
          fi

          echo "âœ… PullGuard analysis complete!"

      - name: Generate Artifact Files
        if: always()
        run: |
          echo "ðŸ“ Generating artifact files..."

          # Check if response.json exists
          if [ ! -f "response.json" ]; then
            echo "âŒ response.json not found! Creating fallback..."
            echo '{"status":"error","pr_summary":"API call failed","violations":{"total":0,"critical":0,"high":0,"medium":0,"low":0,"details":[]},"policy_status":"error","violations_count":0,"ai_suggestions":0}' > response.json
          fi

          # Debug: Show entire response.json
          echo "ðŸ“‹ Full API Response:"
          cat response.json | jq '.' || cat response.json

          # Extract data from API response
          pr_summary=$(cat response.json | jq -r '.pr_summary // "No summary available"')
          violations=$(cat response.json | jq '.violations // {}')
          policy_status=$(cat response.json | jq -r '.policy_status // "unknown"')
          violations_count=$(cat response.json | jq -r '.violations_count // .violations.total // 0')

          echo "Extracted data:"
          echo "- violations_count: $violations_count"
          echo "- policy_status: $policy_status"
          echo "- pr_summary length: ${#pr_summary}"

          # Generate pr_summary.md (directly in root) - unescape newlines
          echo -e "$pr_summary" > pr_summary.md
          echo "âœ… Generated pr_summary.md"

          # Generate issues.json - copy entire response.json with additions
          # Keep ALL fields except pr_summary (which is in PR Summary tab)
          cat response.json | jq '{
            status: .status,
            violations_count: (.violations_count // .violations.total // 0),
            violations: .violations,
            ai_suggestions: .ai_suggestions,
            comments_posted: .comments_posted,
            policy_status: .policy_status,
            timestamp: .timestamp,
            failed_on_policy: .failed_on_policy,
            cost_summary: .cost_summary,
            repository: "${{ github.repository }}",
            pr_number: ${{ github.event.pull_request.number }}
          }' > issues.json
          echo "âœ… Generated issues.json (structured data, no pr_summary)"

          echo "ðŸ“Š Generated issues.json preview:"
          head -30 issues.json

          # Generate policy_report.md with variable expansion
          cat > policy_report.md << EOFPOLICY
          # PullGuard Policy Compliance Report

          **Generated:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          **Overall Status:** $(if [ "$policy_status" = "failed" ]; then echo "âŒ FAILED"; else echo "âœ… PASSED"; fi)

          ## Summary

          - **Total Violations:** $(cat response.json | jq -r '.violations.total')
          - **Critical:** $(cat response.json | jq -r '.violations.critical')
          - **High:** $(cat response.json | jq -r '.violations.high')
          - **Medium:** $(cat response.json | jq -r '.violations.medium')
          - **Low:** $(cat response.json | jq -r '.violations.low')

          ## Policy Rules

          PullGuard enforces the following security policies:

          1. **No Hardcoded Secrets** - API keys, passwords, tokens must use environment variables
          2. **No SQL Injection** - Use parameterized queries, never concatenate user input
          3. **No Command Injection** - Avoid shell=True, sanitize inputs
          4. **No eval/exec** - Dangerous code execution functions prohibited
          5. **Strong Cryptography** - No MD5/SHA1, use SHA256+ or bcrypt/argon2
          6. **Secure Random** - Use secrets module for cryptographic operations
          7. **No Insecure Deserialization** - Avoid pickle with untrusted data

          ## Recommendations

          $(if [ "$policy_status" = "failed" ]; then
            echo "- âŒ **This PR should not be merged** until critical and high severity issues are resolved"
            echo "- Review the inline comments on the PR for specific fixes"
            echo "- Apply AI-suggested fixes where available (click to apply)"
          else
            echo "- âœ… **This PR passes all security policies** and can be merged"
            echo "- Review any low/medium severity warnings for code quality improvements"
          fi)

          ---
          _Generated by PullGuard - Azure AI Security Analysis_
          EOFPOLICY

          echo "âœ… Generated policy_report.md"
          echo ""
          echo "ðŸ“¦ All artifacts generated!"

      - name: Generate Interactive HTML Viewer
        if: always()
        run: |
          echo "ðŸŒ Generating interactive HTML viewer..."

          # Debug: Show file sizes
          echo "ðŸ“Š File sizes before HTML generation:"
          ls -lh pr_summary.md issues.json policy_report.md pullguard-viewer-template.html || echo "Some files missing"

          echo ""
          echo "ðŸ“„ First 200 chars of pr_summary.md:"
          head -c 200 pr_summary.md || echo "Cannot read pr_summary.md"

          echo ""
          echo "ðŸ“‹ First 200 chars of issues.json:"
          head -c 200 issues.json || echo "Cannot read issues.json"

          # Use Python for safe string replacement
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys

          print("ðŸ Python script starting...")

          # Read the template
          with open('pullguard-viewer-template.html', 'r') as f:
              template = f.read()
          print(f"âœ… Template read: {len(template)} chars")

          # Read content files
          with open('pr_summary.md', 'r') as f:
              pr_summary = f.read()
          print(f"âœ… PR Summary read: {len(pr_summary)} chars")

          with open('issues.json', 'r') as f:
              issues_json = f.read()
          print(f"âœ… Issues JSON read: {len(issues_json)} chars")

          with open('policy_report.md', 'r') as f:
              policy_report = f.read()
          print(f"âœ… Policy Report read: {len(policy_report)} chars")

          # Replace placeholders with JSON-escaped content
          pr_summary_escaped = json.dumps(pr_summary)
          issues_json_escaped = json.dumps(issues_json)
          policy_report_escaped = json.dumps(policy_report)

          print(f"âœ… Escaped PR Summary: {len(pr_summary_escaped)} chars")
          print(f"âœ… Escaped Issues JSON: {len(issues_json_escaped)} chars")
          print(f"âœ… Escaped Policy Report: {len(policy_report_escaped)} chars")

          template = template.replace('`__PR_SUMMARY__`', pr_summary_escaped)
          template = template.replace('`__ISSUES_JSON__`', issues_json_escaped)
          template = template.replace('`__POLICY_REPORT__`', policy_report_escaped)

          # Check if replacements worked
          if '__PR_SUMMARY__' in template:
              print("âš ï¸  WARNING: __PR_SUMMARY__ still in template!")
          if '__ISSUES_JSON__' in template:
              print("âš ï¸  WARNING: __ISSUES_JSON__ still in template!")
          if '__POLICY_REPORT__' in template:
              print("âš ï¸  WARNING: __POLICY_REPORT__ still in template!")

          # Write output
          with open('pullguard-report.html', 'w') as f:
              f.write(template)

          print(f"âœ… HTML viewer generated: {len(template)} chars written")
          PYTHON_SCRIPT

          echo ""
          echo "ðŸ“ Generated HTML file size:"
          ls -lh pullguard-report.html

          echo "âœ… Generated pullguard-report.html"
          echo "ðŸŒ HTML viewer is ready with all content embedded!"

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          destination_dir: reports/pr-${{ github.event.pull_request.number }}
          keep_files: true
          enable_jekyll: false

      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pullguard-analysis
          path: |
            pr_summary.md
            issues.json
            policy_report.md

      - name: Job Summary
        if: always()
        run: |
          echo "## ðŸ”’ PullGuard Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "response.json" ]; then
            violations_total=$(cat response.json | jq -r '.violations.total')
            violations_critical=$(cat response.json | jq -r '.violations.critical')
            violations_high=$(cat response.json | jq -r '.violations.high')
            violations_medium=$(cat response.json | jq -r '.violations.medium')
            violations_low=$(cat response.json | jq -r '.violations.low')
            ai_suggestions=$(cat response.json | jq -r '.ai_suggestions')
            comments_posted=$(cat response.json | jq -r '.comments_posted')
            policy_status=$(cat response.json | jq -r '.policy_status')

            echo "**Policy Status:** \`$policy_status\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### ðŸ“Š Analysis Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**AST Policy Violations:** $violations_total _(all posted, no limit)_" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ Critical: $violations_critical" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  High: $violations_high" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Medium: $violations_medium" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”µ Low: $violations_low" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ¤– AI-Powered Code Fixes:** $ai_suggestions _(max: 30)_" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Comments Posted:** $comments_posted" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### ðŸŒ Interactive Report Viewer" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**[ðŸš€ Open Interactive Report](https://sristikulkarni-gif.github.io/PullGuardTest/reports/pr-${{ github.event.pull_request.number }}/pullguard-report.html)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘† Click above to view the report directly in your browser (no download needed!)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The interactive viewer includes:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ›¡ï¸ **Beautiful PullGuard UI** with statistics dashboard" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“„ **PR Summary** - View in modal dialog" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“‹ **Issues JSON** - Formatted with syntax highlighting" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“Š **Policy Report** - Full compliance details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Download Raw Files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**[ðŸ“¥ Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)** (scroll to bottom of page)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Files included in \`pullguard-analysis.zip\`:" >> $GITHUB_STEP_SUMMARY
            echo "- \`pr_summary.md\` - Markdown summary" >> $GITHUB_STEP_SUMMARY
            echo "- \`issues.json\` - Machine-readable findings" >> $GITHUB_STEP_SUMMARY
            echo "- \`policy_report.md\` - Policy compliance report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### ðŸ“ Quick View" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View PR Summary (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f "pr_summary.md" ]; then
              cat pr_summary.md >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "_ðŸ’¡ Click on AI suggestions in PR comments to apply fixes directly_" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "*Powered by [PullGuard](https://github.com/sristikulkarni-gif/PullGuardProject) - Azure AI Security Analysis*" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No response data available" >> $GITHUB_STEP_SUMMARY
          fi
